{% extends "base.html" %} {% block title %}Publication - {{ publication.Title }}{% endblock %} {% block content %}
<div class="container mt-4">
    <h2>Publication: <span class="text-primary">{{ publication.Title }}</span></h2>
    <p class="text-muted">
        <i class="fas fa-link"></i>
        <a href="{{ publication.Link }}" target="_blank">View Original Publication</a>
    </p>

    <!-- Summary Section -->
    <div id="summary-section" class="mb-4">
        {% if analysis %}
        <h4>AI Summary</h4>
        <div class="border p-3 rounded" style="background:#f8f9fa; white-space: pre-line;">
            {{ analysis.summary }}
        </div>

        <h5 class="mt-3">Extracted Preview</h5>
        <pre class="border p-3 rounded" style="max-height:800px; overflow-y:auto;">{{ analysis.text_preview }}</pre> {% else %}
        <p class="text-muted">No summary available yet. Upload a PDF to generate one.</p>
        {% endif %}
    </div>


    <!-- PDF Upload Section -->
    <h4>Upload Your PDF for Summary</h4>
    <form id="pdf-upload-form" enctype="multipart/form-data">
        <div class="mb-3">
            <input type="file" name="pdf_file" id="pdf-file" class="form-control" accept="application/pdf" required>
        </div>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-upload"></i> Upload & Summarize
        </button>
    </form>
</div>

<!-- Include D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {

        function renderKG(kgData) {
            const svg = d3.select("#kg-container");
            svg.selectAll("*").remove();

            const width = svg.node().clientWidth;
            const height = svg.node().clientHeight;

            const simulation = d3.forceSimulation(kgData.nodes)
                .force("link", d3.forceLink(kgData.edges).id((d, i) => i).distance(120))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g")
                .attr("stroke", "#888")
                .attr("stroke-width", 1.5)
                .selectAll("line")
                .data(kgData.edges)
                .join("line");

            const node = svg.append("g")
                .selectAll("circle")
                .data(kgData.nodes)
                .join("circle")
                .attr("r", 18)
                .attr("fill", "#4285f4")
                .call(drag(simulation));

            const label = svg.append("g")
                .selectAll("text")
                .data(kgData.nodes)
                .join("text")
                .text(d => d.label)
                .attr("text-anchor", "middle")
                .attr("dy", 4)
                .attr("fill", "#fff")
                .style("pointer-events", "none")
                .style("font-size", "12px");

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                label
                    .attr("x", d => d.x)
                    .attr("y", d => d.y + 4);
            });

            function drag(simulation) {
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }

                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
                return d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended);
            }
        }

        const pdfForm = document.getElementById("pdf-upload-form");
        pdfForm.addEventListener("submit", async(e) => {
            e.preventDefault();
            const formData = new FormData(pdfForm);
            const btn = pdfForm.querySelector("button");
            btn.disabled = true;
            btn.innerHTML = "Processing...";

            try {
                const res = await fetch("/api/upload_pdf", {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload"></i> Upload & Summarize';

                if (data.error) return alert("Error: " + data.error);

                document.getElementById("summary-section").innerHTML = `
                <h4>AI Summary</h4>
                <div class="border p-3 rounded" style="background:#f8f9fa; white-space: pre-line;">
                    ${data.summary}
                </div>
                <h5 class="mt-3">Extracted Preview</h5>
                <pre class="border p-3 rounded" style="max-height:400px; overflow-y:auto;">
                    ${data.text_preview}
                </pre>
            `;
            } catch (err) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload"></i> Upload & Summarize';
                alert("Unexpected error: " + err.message);
            }
        });

    });
</script>
{% endblock %}