{% extends "base.html" %} {% block title %}Publication - {{ publication.Title }}{% endblock %} {% block content %}

<div class="container mt-4">
    <h2>{{ publication.Title }}</h2>

    <p class="text-muted">
        <i class="fas fa-link"></i>
        <a href="{{ publication.Link }}" target="_blank">Original Publication</a>
    </p>

    <!-- Summary Section -->
    <div id="summary-section" class="mb-4">
        {% if analysis %}
        <h4>AI Summary</h4>
        <div style="white-space: pre-line;">{{ analysis.summary }}</div>

        <h5>Extracted Preview</h5>
        <pre style="background:#f8f9fa; padding:1rem; border-radius:6px; max-height:400px; overflow-y:auto;">
{{ analysis.text_preview }}
        </pre> {% else %}
        <div class="text-center mb-3">
            <button id="analyze-btn" class="btn btn-primary">
                <i class="fas fa-magic"></i> Generate Summary
            </button>
        </div>
        {% endif %}
    </div>

    <!-- PDF Upload Section -->
    <h4>Upload a PDF to Summarize</h4>
    <form id="pdf-upload-form" enctype="multipart/form-data">
        <div class="mb-3">
            <input type="file" name="pdf_file" id="pdf-file" class="form-control" accept="application/pdf" required>
        </div>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-upload"></i> Upload & Summarize
        </button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Existing summary button (for cached publications)
        const analyzeBtn = document.getElementById("analyze-btn");
        if (analyzeBtn) {
            analyzeBtn.addEventListener("click", async() => {
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = "Processing...";

                const res = await fetch(`/api/analyze/{{ pub_id }}`);
                const data = await res.json();

                if (data.error) {
                    alert("Error: " + data.error);
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = "Generate Summary";
                    return;
                }

                document.getElementById("summary-section").innerHTML = `
                <h4>AI Summary</h4>
                <div style="white-space: pre-line;">${data.summary}</div>
                <h5>Extracted Preview</h5>
                <pre style="background:#f8f9fa; padding:1rem; border-radius:6px; max-height:400px; overflow-y:auto;">
${data.text_preview}
                </pre>
            `;
            });
        }

        // Handle PDF Upload
        const pdfForm = document.getElementById("pdf-upload-form");
        pdfForm.addEventListener("submit", async(e) => {
            e.preventDefault();
            const formData = new FormData(pdfForm);

            const btn = pdfForm.querySelector("button");
            btn.disabled = true;
            btn.innerHTML = "Processing...";

            const res = await fetch("/api/upload_pdf", {
                method: "POST",
                body: formData
            });

            const data = await res.json();
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload"></i> Upload & Summarize';

            if (data.error) {
                alert("Error: " + data.error);
                return;
            }

            document.getElementById("summary-section").innerHTML = `
            <h4>AI Summary</h4>
            <div style="white-space: pre-line;">${data.summary}</div>
            <h5>Extracted Preview</h5>
            <pre style="background:#f8f9fa; padding:1rem; border-radius:6px; max-height:400px; overflow-y:auto;">
${data.text_preview}
            </pre>
        `;
        });
    });
</script>

{% endblock %}